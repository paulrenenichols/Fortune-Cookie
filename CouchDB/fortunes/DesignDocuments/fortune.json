{	
	
	"_id": "_design/fortune",

	"language": "javascript",
	
	"validate_doc_update": 
	"function(newDoc, oldDoc, userCtx) {
		
		function require(field, message) {
			message = message || "Document must have a " + field;
			if (!newDoc[field]) throw({forbidden : message});
		};
		
		function unchanged(field) {
			if (oldDoc && toJSON(oldDoc[field] != toJSON(newDoc[field])) {
				throw({forbidden : "Field can't be changed: " + field});
			}
		};
		
		if (newDoc.type == "fortune") {
			require("body");
			require("sequence_id");
			require("created_at");
			
			if(!oldDoc && (newDoc["sequnce_id"] != 0) {
				throw({forbidden : "Non-Zero sequence id provide for new fortune"});
			}
			
			if(!oldDoc && (newDoc["created_at"] != "") {
				throw({forbidden : "created_at should be empty for new fortunes"});
			}
			
			unchanged("sequence_id");
			unchanged("created_at");
		}
	};",
	
	"views": { 
		"fortune_count":
			"map": "function(doc) {
				if(doc.sequence_id && doc.body) {
					emit(doc.sequence_id, doc.body);
			};",
			"reduce": "_count"
	},
	
	"shows": {
	},
	
}